# ==========================================================
# CLUSTER 01 - R√âPLICAS LOCAIS (Read-Only)
# ==========================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: replica-config
  namespace: default
data:
  init-replica.sh: |
    #!/bin/bash
    set -e
    echo "üîÑ Init R√©plica Local..."
    
    PRIMARY_HOST="postgres-global-master.default.svc.cluster.local"
    DATA_DIR="/var/lib/postgresql/data/pgdata"
    
    echo "‚è≥ Aguardando Master em $PRIMARY_HOST..."
    until pg_isready -h $PRIMARY_HOST -U postgres; do sleep 3; done
    
    if [ ! -f "$DATA_DIR/standby.signal" ]; then
        if [ "$(ls -A $DATA_DIR)" ]; then
            rm -rf $DATA_DIR/*
        fi
    fi
    
    if [ -z "$(ls -A $DATA_DIR)" ]; then
        PGPASSWORD=replicator123 pg_basebackup \
             -h $PRIMARY_HOST \
             -U replicator \
             -D $DATA_DIR \
             -Fp -Xs -P -R
    fi
    echo "‚úÖ R√©plica Pronta!"

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres-replica-local
  namespace: default
spec:
  serviceName: "postgres-replica"
  replicas: 2
  selector:
    matchLabels:
      app: postgres
      role: replica-local
      cluster: c1
  template:
    metadata:
      labels:
        app: postgres
        role: replica-local
        cluster: c1
    spec:
      initContainers:
      - name: setup-replica
        image: postgres:15-alpine
        env:
        - name: PGDATA
          value: "/var/lib/postgresql/data/pgdata"
        volumeMounts:
        - name: postgres-data
          mountPath: /var/lib/postgresql/data
        - name: config
          mountPath: /scripts
        command: ["/bin/bash", "/scripts/init-replica.sh"]
      
      containers:
      - name: postgres
        image: postgres:15-alpine
        args:
          - "postgres"
          - "-c"
          - "cluster.k8s_node=$(K8S_NODE_NAME)"
          - "-c"
          - "cluster.k8s_name=$(CLUSTER_NAME)"
        env:
        - name: POSTGRES_USER
          value: "postgres"
        - name: PGDATA
          value: "/var/lib/postgresql/data/pgdata"
        - name: K8S_NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        - name: CLUSTER_NAME
          valueFrom:
            configMapKeyRef:
              name: global-config
              key: cluster-name
        ports:
        - containerPort: 5432
        volumeMounts:
        - name: postgres-data
          mountPath: /var/lib/postgresql/data
        livenessProbe:
          exec:
            command: ["pg_isready", "-U", "postgres"]
          initialDelaySeconds: 30
          periodSeconds: 10
      volumes:
      - name: config
        configMap:
          name: replica-config
          defaultMode: 0755
  volumeClaimTemplates:
  - metadata:
      name: postgres-data
    spec:
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 10Gi