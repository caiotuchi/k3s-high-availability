# ==========================================================
# CLUSTER 02 - RÃ‰PLICAS REMOTAS (Read-Only)
# ==========================================================

apiVersion: v1
kind: ConfigMap
metadata:
  name: global-config
  namespace: default
data:
  cluster-name: "Cluster-02"

---
# Ponte para achar o Master do C1
apiVersion: v1
kind: Service
metadata:
  name: postgres-global-master
  namespace: default
  annotations:
    service.cilium.io/global: "true"
spec:
  ports:
  - port: 5432
    name: postgres
  type: ClusterIP
  selector:
    app: postgres
    role: primary

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: replica-remote-config
  namespace: default
data:
  init-replica.sh: |
    #!/bin/bash
    set -e
    echo "ðŸ”„ Init RÃ©plica Remota (C2)..."
    
    PRIMARY_HOST="postgres-global-master.default.svc.cluster.local"
    DATA_DIR="/var/lib/postgresql/data/pgdata"
    CONFIG_FILE="$DATA_DIR/postgresql.auto.conf"
    
    echo "â³ Aguardando Master Global..."
    until pg_isready -h $PRIMARY_HOST -U postgres; do sleep 5; done
    
    if [ ! -f "$DATA_DIR/standby.signal" ]; then
        if [ "$(ls -A $DATA_DIR)" ]; then
            echo "ðŸ§¹ Limpando dados invÃ¡lidos..."
            rm -rf $DATA_DIR/*
        fi
    fi
    
    if [ -z "$(ls -A $DATA_DIR)" ]; then
        echo "ðŸ“¦ Clonando do Master Global..."
        PGPASSWORD=replicator123 pg_basebackup \
             -h $PRIMARY_HOST \
             -U replicator \
             -D $DATA_DIR \
             -Fp -Xs -P -R
    fi

    echo "ðŸ”§ Aplicando tunings de WAN..."
    touch $CONFIG_FILE
    sed -i '/wal_receiver_timeout/d' $CONFIG_FILE
    sed -i '/wal_receiver_status_interval/d' $CONFIG_FILE
    sed -i '/hot_standby_feedback/d' $CONFIG_FILE

    echo "wal_receiver_timeout = 60s" >> $CONFIG_FILE
    echo "wal_receiver_status_interval = 5s" >> $CONFIG_FILE
    echo "hot_standby_feedback = on" >> $CONFIG_FILE

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres-replica-remote
  namespace: default
spec:
  serviceName: "postgres-replica"
  replicas: 3
  selector:
    matchLabels:
      app: postgres
      role: replica-remote
      cluster: c2
  template:
    metadata:
      labels:
        app: postgres
        role: replica-remote
        cluster: c2
    spec:
      initContainers:
      - name: setup-replica
        image: postgres:15-alpine
        env:
        - name: PGDATA
          value: "/var/lib/postgresql/data/pgdata"
        volumeMounts:
        - name: postgres-data
          mountPath: /var/lib/postgresql/data
        - name: config
          mountPath: /scripts
        command: ["/bin/bash", "/scripts/init-replica.sh"]
      
      containers:
      - name: postgres
        image: postgres:15-alpine
        args:
          - "postgres"
          - "-c"
          - "cluster.k8s_node=$(K8S_NODE_NAME)"
          - "-c"
          - "cluster.k8s_name=$(CLUSTER_NAME)"
        env:
        - name: POSTGRES_USER
          value: "postgres"
        - name: PGDATA
          value: "/var/lib/postgresql/data/pgdata"
        - name: K8S_NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        - name: CLUSTER_NAME
          valueFrom:
            configMapKeyRef:
              name: global-config
              key: cluster-name
        ports:
        - containerPort: 5432
        volumeMounts:
        - name: postgres-data
          mountPath: /var/lib/postgresql/data
        livenessProbe:
          exec:
            command: ["pg_isready", "-U", "postgres"]
          initialDelaySeconds: 30
          periodSeconds: 10
      volumes:
      - name: config
        configMap:
          name: replica-remote-config
          defaultMode: 0755
  volumeClaimTemplates:
  - metadata:
      name: postgres-data
    spec:
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 10Gi